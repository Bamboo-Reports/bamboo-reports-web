# Purchases Database Schema

## Overview
This document describes the database schema for the purchases functionality in the Bamboo Reports application.

## Tables

### purchases

This table stores all purchase transactions made by users.

```sql
-- Create purchases table
CREATE TABLE IF NOT EXISTS public.purchases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  order_id TEXT NOT NULL UNIQUE,
  razorpay_order_id TEXT,
  razorpay_payment_id TEXT,
  plan_name TEXT NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'INR',
  status TEXT NOT NULL DEFAULT 'pending',
  features JSONB,
  payment_method TEXT,
  purchased_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index on user_id for faster queries
CREATE INDEX IF NOT EXISTS idx_purchases_user_id ON public.purchases(user_id);

-- Create index on order_id for faster lookups
CREATE INDEX IF NOT EXISTS idx_purchases_order_id ON public.purchases(order_id);

-- Enable Row Level Security
ALTER TABLE public.purchases ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view their own purchases
CREATE POLICY "Users can view own purchases"
  ON public.purchases
  FOR SELECT
  USING (auth.uid() = user_id);

-- Policy: Service role can insert purchases (used by payment verification)
CREATE POLICY "Service role can insert purchases"
  ON public.purchases
  FOR INSERT
  WITH CHECK (true);

-- Policy: Service role can update purchases
CREATE POLICY "Service role can update purchases"
  ON public.purchases
  FOR UPDATE
  USING (true);

-- Function to update the updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to automatically update updated_at
CREATE TRIGGER update_purchases_updated_at
  BEFORE UPDATE ON public.purchases
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

## Column Descriptions

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key, auto-generated |
| `user_id` | UUID | Foreign key to auth.users, the user who made the purchase |
| `order_id` | TEXT | Unique order ID generated by the application |
| `razorpay_order_id` | TEXT | Order ID from Razorpay |
| `razorpay_payment_id` | TEXT | Payment ID from Razorpay |
| `plan_name` | TEXT | Name of the purchased plan (Base Layer, Custom Layer) |
| `amount` | DECIMAL | Purchase amount |
| `currency` | TEXT | Currency code (INR, USD) |
| `status` | TEXT | Payment status (pending, completed, failed) |
| `features` | JSONB | JSON array of features included in the plan |
| `payment_method` | TEXT | Payment method used (card, upi, netbanking, etc.) |
| `purchased_at` | TIMESTAMP | When the purchase was completed |
| `created_at` | TIMESTAMP | When the record was created |
| `updated_at` | TIMESTAMP | Last update timestamp |

## Setup Instructions

1. Log in to your Supabase dashboard
2. Navigate to the SQL Editor
3. Copy and paste the SQL commands above
4. Execute the script to create the table and policies
5. Verify the table was created successfully in the Table Editor

## Row Level Security (RLS)

The purchases table has RLS enabled with the following policies:

- **SELECT**: Users can only view their own purchases (filtered by `user_id`)
- **INSERT/UPDATE**: Only the service role can create and update purchases (used by payment verification serverless functions)

## Integration Notes

- The `verify-payment.js` serverless function should insert records into this table after successful payment verification
- The Purchases page will query this table to display user purchases
- Features are stored as JSONB to allow flexible querying and display
